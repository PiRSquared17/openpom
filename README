------------------------------
        OpenPOM how-to 
------------------------------

  Copyright 2010, Exosec
  Licensed under GPL Version 2.
  http://www.gnu.org/licenses/


1) Requirements
---------------

- Nagios (http://nagios.org/) installation with a contact_name admin 
or
- icinga (http://www.icinga.org/)

- MySQL 

- NdoUtils  (NDOUtils : http://www.nagios.org/download/addons)

- A web server (Apache/Apache2) with php5

2) Configure NdoUtils
---------------------

After NdoUtils install don't forget to add the broker in nagios or icinga conf.

event_broker_options=-1
broker_module=/usr/lib/ndoutils/ndomod-mysql-3x.o config_file=/etc/nagios3/ndomod.cfg

Grant access to your Ndo MySQL base (assume name is ndoutils)

mysql> grant select on ndoutils.* to 'openpom'@'127.0.0.1' identified by 'my_password';
mysql> flush privileges;

For performance reason you have to set up index on some ndoutils tables.
Connect to your mysql server and use the correct database then inject these lines :
ALTER TABLE `nagios_commenthistory` ADD INDEX ( `object_id` );
ALTER TABLE `nagios_commenthistory` ADD INDEX ( `entry_time` );
ALTER TABLE `nagios_commenthistory` ADD INDEX ( `author_name` );
ALTER TABLE `nagios_commenthistory` ADD INDEX ( `deletion_time` );
ALTER TABLE `nagios_commenthistory` ADD INDEX ( `entry_type` );
ALTER TABLE `nagios_commenthistory` ADD INDEX ( `comment_data` );
ALTER TABLE `nagios_contactgroup_members` ADD INDEX ( `contactgroup_id` );
ALTER TABLE `nagios_contactgroups` ADD INDEX ( `contactgroup_object_id` );
ALTER TABLE `nagios_contacts` ADD INDEX ( `contact_object_id` );
ALTER TABLE `nagios_downtimehistory` ADD INDEX ( `actual_end_time` );
ALTER TABLE `nagios_host_contactgroups` ADD INDEX ( `host_id` );
ALTER TABLE `nagios_hostgroup_members` ADD INDEX ( `hostgroup_id` );
ALTER TABLE `nagios_hostgroup_members` ADD INDEX ( `host_object_id` );
ALTER TABLE `nagios_hostgroups` ADD INDEX ( `hostgroup_object_id` );
ALTER TABLE `nagios_objects` ADD INDEX ( `objecttype_id` );
ALTER TABLE `nagios_objects` ADD INDEX ( `name1` );
ALTER TABLE `nagios_scheduleddowntime` ADD INDEX ( `downtime_type` );
ALTER TABLE `nagios_service_contactgroups` ADD INDEX ( `service_id` );
ALTER TABLE `nagios_service_contactgroups` ADD INDEX ( `contactgroup_object_id` );
ALTER TABLE `nagios_services` ADD INDEX ( `host_object_id` );

3) Configure OpenPom
--------------------

Adjust the following variables in config.php:

/* SQL */
$SQL_HOST           = "127.0.0.1";
$SQL_USER           = "openpom";
$SQL_PASSWD         = "my_password";
$SQL_DB             = "ndoutils";

/* NAGIOS */
$EXEC_CMD           = "./send-order";
$CMD_FILE           = "/usr/local/nagios/var/rw/nagios.cmd";
$LINK               = "/".$BACKEND."/cgi-bin/extinfo.cgi";
$LOG                = "/".$BACKEND."/cgi-bin/showlog.cgi";

!!! Check that you have the right to write in the nagios or icinga cmd file !!!
chown :www-data /usr/local/nagios/var/rw/nagios.cmd
chmod g+w /usr/local/nagios/var/rw/nagios.cmd
or with sudo add this to your sudoers :
www-data  ALL=(ALL) NOPASSWD: PATH/nagios-send-order


4) Configure Apache2
--------------------

4.1) Apache global authentification
-----------------------------------

  Alias       /openpom    /var/www/openpom
  <Directory /var/www/openpom>
     Options ExecCGI Indexes
     AllowOverride None
     Order allow,deny
     Allow from all

     AuthName "OpenPom Access"
     AuthType Basic
     AuthUserFile  /etc/nagios/http-passwd
     AuthGroupFile /etc/nagios/http-group
     Require groupe nagios
     Satisfy Any

     SetEnv REMOTE_USER root
  </Directory>

!!! The REMOTE_USER user name must match a contact_name in nagios or icinga contact.cfg !!!

4.2) Apache local authentification
-----------------------------------

  Alias       /openpom            /var/www/openpom
  <Directory /var/www/openpom>
     Options ExecCGI Indexes
     AllowOverride None
     Order allow,deny
     Allow from all

     AuthName "OpenPom Access"
     AuthType Basic
     AuthUserFile  /etc/nagios/http-passwd
     Require valid-user
  </Directory>


Add your user:password with htpasswd in /etc/nagios/http-passwd

!!! The user name must match a contact_name in nagios or icinga contact.cfg !!!

5) Graph
--------

You can show graph from external sources (like rrdgraph, pnp, cacti, ...)
Edit config.php and add the following two arrays:

/* SHOW GRPAH FROM EXTERNAL SOURCE ON STATUS */
$GRAPH_STATUS = array(
  'target'       => '', 
  'p_host'       => 'host', 
  'p_svc'        => 'service', 
  'host_is_ping' => false
);

/* SHOW GRAPH ICON ON ALERT (open a popup with external graph) */
$GRAPH_POPUP = array(
  'target'       => '', 
  'p_host'       => 'host', 
  'p_svc'        => 'service', 
  'host_is_ping' => false
);

Here is a short description of the keys present in the arrays:

a) « target » corresponds to the source URL to use;
b) « p_host » corresponds to the name of the host parameter to use in the query string;
c) « p_svc » corresponds to the name of the service parameter to use in the query string;
d) « host_is_ping », when true will treat --host-- as PING

Example, configuration of graphs on the status popin, which is displayed when mouseovering a row in the alert table:

$GRAPH_STATUS = array(
  'target'       => '/nagios/cgi-bin/trends.cgi?createimage&backtrack=4&zoom=4',
  'p_host'       => 'host',
  'p_svc'        => 'service',
  'host_is_ping' => false
);

When mouse goes over a row of type « host », the status popin will display the image available at the following URL: 

/nagios/cgi-bin/trends.cgi?createimage&backtrack=4&zoom=4&host=@HOST@

As we are, in this example, considering a row of type « host », if host_is_ping was to be true, the URL would become the following:

/nagios/cgi-bin/trends.cgi?createimage&backtrack=4&zoom=4&host=@HOST@&service=PING

6) Note
-------

Supported Navigators :
  - Firefox 3.X
  - IE > 6
  - Opera 10
  - Chrome

There are 2 keywords that you can use in the search filter :

not something_to_search : inverse the search filter

= something_to_search   : exact match your search


7) Contributors
---------------

Sylvain Choisnard  - schoisnard@exosec.fr
Benoit  Dolez      - bdolez@exosec.fr
Thierry Fournier   - tfournier@exosec.fr
Bertrand Jacquin   - bjacquin@exosec.fr
Alexandre Bray     - abray@exosec.fr
